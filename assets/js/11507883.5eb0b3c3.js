"use strict";(self.webpackChunkfrourio_doc=self.webpackChunkfrourio_doc||[]).push([[1184],{8215:function(e,t,n){var r=n(7294);t.Z=function(e){var t=e.children,n=e.hidden,a=e.className;return r.createElement("div",{role:"tabpanel",hidden:n,className:a},t)}},9877:function(e,t,n){n.d(t,{Z:function(){return p}});var r=n(3117),a=n(7294),s=n(2389),o=n(4726),i=n(6010),l="tabItem_LplD";function u(e){var t,n,s,u=e.lazy,p=e.block,d=e.defaultValue,c=e.values,f=e.groupId,m=e.className,y=a.Children.map(e.children,(function(e){if((0,a.isValidElement)(e)&&void 0!==e.props.value)return e;throw new Error("Docusaurus error: Bad <Tabs> child <"+("string"==typeof e.type?e.type:e.type.name)+'>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.')})),h=null!=c?c:y.map((function(e){var t=e.props;return{value:t.value,label:t.label,attributes:t.attributes}})),k=(0,o.lx)(h,(function(e,t){return e.value===t.value}));if(k.length>0)throw new Error('Docusaurus error: Duplicate values "'+k.map((function(e){return e.value})).join(", ")+'" found in <Tabs>. Every value needs to be unique.');var v=null===d?d:null!=(t=null!=d?d:null==(n=y.find((function(e){return e.props.default})))?void 0:n.props.value)?t:null==(s=y[0])?void 0:s.props.value;if(null!==v&&!h.some((function(e){return e.value===v})))throw new Error('Docusaurus error: The <Tabs> has a defaultValue "'+v+'" but none of its children has the corresponding value. Available values are: '+h.map((function(e){return e.value})).join(", ")+". If you intend to show no default tab, use defaultValue={null} instead.");var g=(0,o.UB)(),b=g.tabGroupChoices,N=g.setTabGroupChoices,w=(0,a.useState)(v),x=w[0],T=w[1],$=[],E=(0,o.o5)().blockElementScrollPositionUntilNextRender;if(null!=f){var I=b[f];null!=I&&I!==x&&h.some((function(e){return e.value===I}))&&T(I)}var j=function(e){var t=e.currentTarget,n=$.indexOf(t),r=h[n].value;r!==x&&(E(t),T(r),null!=f&&N(f,r))},A=function(e){var t,n=null;switch(e.key){case"ArrowRight":var r=$.indexOf(e.currentTarget)+1;n=$[r]||$[0];break;case"ArrowLeft":var a=$.indexOf(e.currentTarget)-1;n=$[a]||$[$.length-1]}null==(t=n)||t.focus()};return a.createElement("div",{className:"tabs-container"},a.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,i.Z)("tabs",{"tabs--block":p},m)},h.map((function(e){var t=e.value,n=e.label,s=e.attributes;return a.createElement("li",(0,r.Z)({role:"tab",tabIndex:x===t?0:-1,"aria-selected":x===t,key:t,ref:function(e){return $.push(e)},onKeyDown:A,onFocus:j,onClick:j},s,{className:(0,i.Z)("tabs__item",l,null==s?void 0:s.className,{"tabs__item--active":x===t})}),null!=n?n:t)}))),u?(0,a.cloneElement)(y.filter((function(e){return e.props.value===x}))[0],{className:"margin-vert--md"}):a.createElement("div",{className:"margin-vert--md"},y.map((function(e,t){return(0,a.cloneElement)(e,{key:t,hidden:e.props.value!==x})}))))}function p(e){var t=(0,s.Z)();return a.createElement(u,(0,r.Z)({key:String(t)},e))}},709:function(e,t,n){var r=n(7294),a=n(9877),s=n(8215),o=n(2197);t.Z=function(e){var t=e.deps,n=e.devDeps,l=e.before,u=e.after,p=function(e){return[].concat(null!=l?l:[],t?[e+" "+i(e)+" "+t.join(" ")]:[],n?[e+" "+i(e)+" -D "+n.join(" ")]:[],null!=u?u:[])};return r.createElement(a.Z,{groupId:"node-package-manager",defaultValue:"npm",values:[{label:"npm",value:"npm"},{label:"yarn",value:"yarn"}]},r.createElement(s.Z,{value:"npm"},r.createElement(o.Z,{language:"sh"},p("npm").join("\n"))),r.createElement(s.Z,{value:"yarn"},r.createElement(o.Z,{language:"sh"},p("yarn").join("\n"))))};var i=function(e){switch(e){case"npm":return"install";case"yarn":return"add"}}},3824:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return p},contentTitle:function(){return d},metadata:function(){return c},toc:function(){return f},default:function(){return y}});var r=n(3117),a=n(102),s=(n(7294),n(3905)),o=n(9877),i=n(8215),l=n(709),u=["components"],p={id:"authentication",title:"Authentication"},d=void 0,c={unversionedId:"guide/authentication",id:"guide/authentication",title:"Authentication",description:"Use AdditionalRequest to share data between hooks and controller.",source:"@site/docs/guide/authentication.mdx",sourceDirName:"guide",slug:"/guide/authentication",permalink:"/docs/guide/authentication",editUrl:"https://github.com/frouriojs/frourio.com/edit/master/docs/guide/authentication.mdx",tags:[],version:"current",frontMatter:{id:"authentication",title:"Authentication"},sidebar:"docs",previous:{title:"Custom Entrypoint",permalink:"/docs/guide/entrypoint"},next:{title:"CORS / Helmet",permalink:"/docs/guide/cors-helmet"}},f=[{value:"Examples",id:"examples",children:[],level:2}],m={toc:f};function y(e){var t=e.components,n=(0,a.Z)(e,u);return(0,s.kt)("wrapper",(0,r.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,s.kt)("div",{parentName:"div",className:"admonition-heading"},(0,s.kt)("h5",{parentName:"div"},(0,s.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,s.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,s.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,s.kt)("div",{parentName:"div",className:"admonition-content"},(0,s.kt)("p",{parentName:"div"},"Use ",(0,s.kt)("a",{parentName:"p",href:"/docs/reference/additionalRequest"},"AdditionalRequest")," to share data between hooks and controller."))),(0,s.kt)("h2",{id:"examples"},"Examples"),(0,s.kt)(o.Z,{defaultValue:"fastify-jwt",values:[{label:"@fastify/jwt",value:"fastify-jwt"},{label:"@fastify/auth",value:"fastify-auth"},{label:"express-jwt",value:"express-jwt"},{label:"express-passport",value:"express-passport"}],mdxType:"Tabs"},(0,s.kt)(i.Z,{value:"fastify-jwt",mdxType:"TabItem"},(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("a",{parentName:"li",href:"https://github.com/fastify/fastify-jwt"},"fastify/fastify","-","jwt: JWT utils for Fastify"))),(0,s.kt)(l.Z,{before:["cd server"],deps:["@fastify/jwt"],mdxType:"PackageInstallTabs"}),(0,s.kt)("h3",null,"Register the plugin"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="$/service/app.ts"',title:'"$/service/app.ts"'},"import Fastify, { FastifyServerFactory } from 'fastify'\nimport fastifyJwt from '@fastify/jwt'\nimport { API_JWT_SECRET, API_BASE_PATH } from '$/service/envValues'\nimport server from './$server'\n\nexport const init = (serverFactory?: FastifyServerFactory) => {\n  const app = Fastify({ serverFactory })\n  app.register(fastifyJwt, { secret: API_JWT_SECRET })\n  server(app, { basePath: API_BASE_PATH })\n  return app\n}\n")),(0,s.kt)("h3",null,"Issue tokens"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="$/api/token/controller.ts"',title:'"$/api/token/controller.ts"'},"import { defineController } from './$relay'\nimport { validateUser } from '$/service/user'\n\nexport default defineController((fastify) => ({\n  post: ({ body }) =>\n    validateUser(body.id, body.pass)\n      ? { status: 201, body: { token: fastify.jwt.sign({ id: body.id }) } }\n      : { status: 401 },\n}))\n")),(0,s.kt)("h3",null,"Verify tokens"),(0,s.kt)("p",null,"Although ",(0,s.kt)("inlineCode",{parentName:"p"},"@fastify/jwt")," extends ",(0,s.kt)("inlineCode",{parentName:"p"},"FastifyRequest"),", it is not reflected to the controller, so you need to prepare it yourself in order to reference it in the controller."),(0,s.kt)("p",null,(0,s.kt)("em",{parentName:"p"},(0,s.kt)("a",{parentName:"em",href:"/docs/reference/additionalRequest#relaying-of-type-extended-by-plugins"},"Relaying of type extended by plugins"))),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="$/api/user/hooks.ts"',title:'"$/api/user/hooks.ts"'},"import { defineHooks } from './$relay'\n\nexport type AdditionalRequest = {\n  user: {\n    id: string\n  }\n}\n\nexport default defineHooks(() => ({\n  onRequest: (request, reply) => request.jwtVerify().catch((err) => reply.send(err)),\n}))\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="$/api/user/controller.ts"',title:'"$/api/user/controller.ts"'},"import { defineController } from './$relay'\nimport { getUserNameById } from '$/service/user'\n\nexport default defineController(() => ({\n  get: async ({ user }) => ({ status: 200, body: await getUserNameById(user.id) }),\n  //            ^^^^ extended by AdditionalRequest\n}))\n"))),(0,s.kt)(i.Z,{value:"fastify-auth",mdxType:"TabItem"},(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("a",{parentName:"li",href:"https://github.com/fastify/fastify-auth"},"fastify/fastify","-","auth: Run multiple auth functions in Fastify"))),(0,s.kt)(l.Z,{before:["cd server"],deps:["@fastify/auth"],mdxType:"PackageInstallTabs"}),(0,s.kt)("h3",null,"Register the plugin"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="$/service/app.ts"',title:'"$/service/app.ts"'},"import Fastify, { FastifyServerFactory } from 'fastify'\nimport fastifyAuth from '@fastify/auth'\nimport { API_JWT_SECRET, API_BASE_PATH } from '$/service/envValues'\nimport server from './$server'\n\nexport const init = (serverFactory?: FastifyServerFactory) => {\n  const app = Fastify({ serverFactory })\n  app.register(fastifyAuth)\n  server(app, { basePath: API_BASE_PATH })\n  return app\n}\n")),(0,s.kt)("h3",null,"Verify tokens"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="$/api/user/hooks.ts"',title:'"$/api/user/hooks.ts"'},"import { defineHooks } from './$relay'\nimport { getUserIdByToken } from '$/service/user'\n\nexport type AdditionalRequest = {\n  user: {\n    id: string\n  }\n}\n\nexport default defineHooks((fastify) => ({\n  preHandler: fastify.auth([\n    (req, _, done) => {\n      const user = typeof req.headers.token === 'string' && getUserIdByToken(req.headers.token)\n\n      if (user) {\n        // eslint-disable-next-line\n        // @ts-expect-error\n        req.user = user\n        done()\n      } else {\n        done(new Error('Unauthorized'))\n      }\n    },\n  ]),\n}))\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="$/api/user/controller.ts"',title:'"$/api/user/controller.ts"'},"import { defineController } from './$relay'\nimport { getUserNameById } from '$/service/user'\n\nexport default defineController(() => ({\n  // user was added by AdditionalRequest of ./hooks.ts\n  get: async ({ user }) => ({ status: 200, body: await getUserNameById(user.id) }),\n}))\n"))),(0,s.kt)(i.Z,{value:"express-jwt",mdxType:"TabItem"},(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("a",{parentName:"li",href:"https://github.com/auth0/express-jwt"},"auth0/express","-","jwt: connect/express middleware that validates a JsonWebToken ","(","JWT",")"," and set the req",".","user with the attributes"))),(0,s.kt)(l.Z,{before:["cd server"],deps:["express-jwt"],devDeps:["@types/express-jwt","@types/jsonwebtoken"],mdxType:"PackageInstallTabs"}),(0,s.kt)("h3",null,"Issue tokens"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="$/api/token/controller.ts"',title:'"$/api/token/controller.ts"'},"import jwt from 'jsonwebtoken'\nimport { defineController } from './$relay'\nimport { validateUser } from '$/service/user'\n\nexport default defineController(() => ({\n  post: ({ body }) =>\n    validateUser(body.id, body.pass)\n      ? { status: 201, body: { token: jwt.sign({ id: body.id }, process.env.JWT_SECRET) } }\n      : { status: 401 },\n}))\n")),(0,s.kt)("h3",null,"Verify tokens"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="$/api/user/hooks.ts"',title:'"$/api/user/hooks.ts"'},"import jwt from 'express-jwt'\nimport { defineHooks } from './$relay'\n\nexport type AdditionalRequest = {\n  user: {\n    id: string\n  }\n}\n\nexport default defineHooks(() => ({\n  onRequest: jwt({ secret: process.env.JWT_SECRET, algorithms: ['HS256'] }),\n}))\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="$/api/user/controller.ts"',title:'"$/api/user/controller.ts"'},"import { defineController } from './$relay'\nimport { getUserNameById } from '$/service/user'\n\nexport default defineController(() => ({\n  // user was added by AdditionalRequest of ./hooks.ts\n  get: async ({ user }) => ({ status: 200, body: await getUserNameById(user.id) }),\n}))\n"))),(0,s.kt)(i.Z,{value:"express-passport",mdxType:"TabItem"},(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("a",{parentName:"li",href:"https://github.com/jaredhanson/passport"},"jaredhanson/passport: Simple, unobtrusive authentication for Node",".","js",".")),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("a",{parentName:"li",href:"https://www.passportjs.org/packages/passport-trusted-header/"},"passport-trusted-header"))),(0,s.kt)(l.Z,{before:["cd server"],deps:["passport","passport-trusted-header"],devDeps:["@types/passport"],mdxType:"PackageInstallTabs"}),(0,s.kt)("h3",null,"Verify tokens"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="$/api/user/hooks.ts"',title:'"$/api/user/hooks.ts"'},"import passport from 'passport'\nimport { defineHooks } from './$relay'\nimport { getUserIdByToken } from '$/service/user'\n\nexport type AdditionalRequest = {\n  user: {\n    id: string\n  }\n}\n\npassport.use(\n  // eslint-disable-next-line\n  new (require('passport-trusted-header').Strategy)(\n    { headers: ['token'] },\n    // eslint-disable-next-line\n    (headers: { token: string }, done: Function) => {\n      done(null, getUserIdByToken(headers.token))\n    }\n  )\n)\n\nexport default defineHooks(() => ({\n  onRequest: [passport.initialize(), passport.authenticate('trusted-header', { session: false })],\n}))\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="$/api/user/controller.ts"',title:'"$/api/user/controller.ts"'},"import { defineController } from './$relay'\nimport { getUserNameById } from '$/service/user'\n\nexport default defineController(() => ({\n  // user was added by AdditionalRequest of ./hooks.ts\n  get: async ({ user }) => ({ status: 200, body: await getUserNameById(user.id) }),\n}))\n")))))}y.isMDXComponent=!0}}]);