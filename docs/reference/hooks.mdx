---
id: hooks
title: ライフサイクルとフック
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

## Frourio におけるライフサイクル {#lifecycle-in-frourio}

Frourio と frourio-express のどちらも、fastify に似た形式のフックを提供しています。

全体のライフサイクルは下図のようになっていて、`onRequest`, `preParsing`, `preValidation`, `preHandler` などのフックを定義できます。

<div style={{ textAlign: 'center' }}>
  <img src="/img/lifecycle.svg" alt='Frourio におけるライフサイクル' style={{ maxWidth: '300px' }} />

_Ref. [Lifecycle - Fastify](https://www.fastify.io/docs/latest/Reference/Lifecycle/)_

</div>

## 2 種類のフック {#two-types-of-hooks}

Frourio は、**コントローラーレベル フック** と **ディレクトリレベル フック** の 2 種類のフックを提供しています。

- **コントローラーレベル フック**: 現在の階層でのみ呼ばれます
- **ディレクトリレベル フック**: 現在と _配下の_ 階層で呼ばれます

もし両方の種類のフックが同時に呼ばれる場合、**ディレクトリレベル フック** が先に呼ばれます。

## フックを定義する {#define-hooks}

フックを定義するには、`./$relay.ts` でエクスポートされた `defineHooks` 関数を使用します。

- **コントローラーレベル フック**: `controller.ts` で定義します
- **ディレクトリレベル フック**: 目的のディレクトリの `hooks.ts` で定義します

### `defineHooks` 関数 {#function-definehooks}

<Tabs
  groupId='base-framework'
  defaultValue="fastify"
  values={[
    { label: 'Fastify', value: 'fastify' },
    { label: 'Express', value: 'express' },
  ]}
>
<TabItem value="fastify">

#### 引数の型 {#definehooks-argument-type}

- function `(fastify: FastifyInstance) => Hooks`
  - `Hooks` : フック名を key とし、ハンドラ関数（またはその配列）を value とするオブジェクト

### フックハンドラ {#hooks-handler}

#### 引数の型 {#hooks-handler-argument-type}

- `request` : [`FastifyRequest`](https://www.fastify.io/docs/latest/Reference/TypeScript/#request) & [`AdditinalRequest`](/docs/reference/additionalRequest)
- `reply` : [`FastifyReply`](https://www.fastify.io/docs/latest/Reference/TypeScript/#reply)
- `done` : function `<TError extends Error = FastifyError>(err?: TError) => void`

`done` はライフサイクルを続行する関数です。

:::caution
`async`/`await` を使用しているときや `Promise` を返しているときは `done` コールバックを使用できません。このような状況で done コールバックを呼び出すと、ハンドラを重複して呼び出すなど、予期しない動作が発生する可能性があります。

_ref. [Hooks - Fastify](https://www.fastify.io/docs/latest/Reference/Hooks/)_
:::

</TabItem>
<TabItem value="express">

#### 引数の型 {#definehooks-argument-type}

- function `(app: Express) => Hooks`
  - `Hooks` : フック名を key とし、ハンドラ関数（またはその配列）を value とするオブジェクト

### フックハンドラ {#hooks-handler}

#### 引数の型 {#hooks-handler-argument-type}

- `req` : [`Request`](https://expressjs.com/ja/api.html#req) & [`AdditinalRequest`](/docs/reference/additionalRequest)
- `res` : [`Response`](http://expressjs.com/ja/api.html#res)
- `next` : function `(err?: any) => void`

`next` はライフサイクルを続行する関数です。（`async`/`await`を使用しているときや`Promise` を返しているときも含みます。）

</TabItem>
</Tabs>
