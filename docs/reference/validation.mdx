---
id: validation
title: バリデーション
---

:::info
このページの例は Fastify で書かれていますが、Express でも同じ機能が有効です。

Express での例を追加するプルリクエストも歓迎しています！
:::

---

バリデーションには、frourio による自動バリデーションと class-validator を用いたバリデーションの 2 種類があります。

## パスパラメータ {#path-parameter}

パスパラメータに `@string` または `@number` を付けることで型を定義することができ、frourio におけるデフォルトは `string` です。

型が `number` として定義されている場合、frourio は自動的に string から number に変換しそれが NaN でないことを検証します。

:::caution
**型が定義されていない場合、**frourio と aspida の振る舞いには **大きな違いがあります**。

上にあるように frourio は `string` として解釈しますが、aspida は `string | number` として解釈します。
これはパスパラメータが URL を通じて渡されることによる情報の損失に起因します。

特殊な事情がない限り、**型を明示するべきです**。
:::

<details>
<summary>例</summary>

<h3>API 型定義</h3>

```ts title="server/api/tasks/_taskId@number/index.ts"
import { Task } from '$/types';

export type Methods = {
  get: {
    resBody: Task;
  };
};
```

<h3>コントローラー</h3>

```ts title="server/api/tasks/_taskId@number/controller.ts"
import { defineController } from './$relay';
import { findTask } from '$/service/tasks';

export default defineController(() => ({
  get: async ({ params }) => {
    const task = await findTask(params.taskId);

    return task ? { status: 200, body: task } : { status: 404 };
  },
}));
```

<h3>結果</h3>

```sh
$ curl http://localhost:8080/api/tasks
[{"id":0,"label":"sample task","done":false}]

$ curl http://localhost:8080/api/tasks/0
{"id":0,"label":"sample task","done":false}

$ curl http://localhost:8080/api/tasks/1 -i
HTTP/1.1 404 Not Found

$ curl http://localhost:8080/api/tasks/abc -i
HTTP/1.1 400 Bad Request
```

</details>

## URL クエリ {#url-query}

URL クエリが次のように定義されていると…

- required
  - Frourio は自動的にそれが存在するか検証します。
  - それが存在せず、かつ配列として定義されている場合は、frourio が空の配列 `[]` をセットします。
- `number`
  - Frourio は自動的に string から number に変換しそれが NaN でないことを検証します。
- `boolean`
  - Frourio は自動的に string (`'true'` または `'false'`) から boolean に変換します。

<span class="badge badge--secondary">Depricated</span>

また key が角括弧で終わる場合は (例: `foo[]`)、frourio は自動的に角括弧を除去します (例:
`foo`)。

<details>
<summary>例</summary>

<h3>API 型定義</h3>

```ts title="server/api/tasks/index.ts"
import { Task } from '$/types';

export type Methods = {
  get: {
    query?: {
      limit: number;
    };
    resBody: Task[];
  };
};
```

<h3>コントローラー</h3>

```ts title="server/api/tasks/controller.ts"
import { defineController } from './$relay';
import { getTasks } from '$/service/tasks';

export default defineController(() => ({
  get: async ({ query }) => ({
    status: 200,
    body: (await getTasks()).slice(0, query?.limit),
  }),
}));
```

<h3>結果</h3>

```sh
$ curl http://localhost:8080/api/tasks
[{"id":0,"label":"sample task 0","done":false},{"id":1,"label":"sample task 1","done":false},{"id":1,"label":"sample task 2","done":false}]

$ curl http://localhost:8080/api/tasks?limit=1
[{"id":0,"label":"sample task 0","done":false}]

$ curl http://localhost:8080/api/tasks?limit=abc -i
HTTP/1.1 400 Bad Request
```

</details>

## リクエストボディ {#request-body}

`reqFormat` が `FormData` として定義されている場合、frourio は自動的に変換しそれを検証します。

1. 要素が配列の場合、配列に変換します (またそれが存在しないとき、空の配列 `[]` をセットします)。
2. ファイルまたは値を取り出します。
3. 要素が optional として定義されていてそれが空なとき、要素を削除します。

## class-validator {#class-validator}

リクエストボディやリクエストヘッダ、URL クエリをバリデートするには、[class-validator](https://github.com/typestack/class-validator) を用いて reqBody や reqHaders、query の型の代わりに class を定義します。

<details>
<summary>例</summary>

<h3>バリデータ</h3>

```ts title="server/validators/index.ts"
import { MinLength, IsString } from 'class-validator';

export class LoginBody {
  @MinLength(5)
  id: string;

  @MinLength(8)
  pass: string;
}

export class TokenHeader {
  @IsString()
  @MinLength(10)
  token: string;
}
```

<h3>API 型定義</h3>

```ts title="server/api/token/index.ts"
import { LoginBody, TokenHeader } from '$/validators';

export type Methods = {
  post: {
    reqBody: LoginBody;
    resBody: {
      token: string;
    };
  };

  delete: {
    reqHeaders: TokenHeader;
  };
};
```

<h3>結果</h3>

```sh
$ curl -X POST -H "Content-Type: application/json" -d '{"id":"correctId","pass":"correctPass"}' http://localhost:8080/api/token
{"token":"XXXXXXXXXX"}

$ curl -X POST -H "Content-Type: application/json" -d '{"id":"abc","pass":"12345"}' http://localhost:8080/api/token -i
HTTP/1.1 400 Bad Request

$ curl -X POST -H "Content-Type: application/json" -d '{"id":"incorrectId","pass":"incorrectPass"}' http://localhost:8080/api/token -i
HTTP/1.1 401 Unauthorized
```

</details>

### バリデータオプションの指定 {#passing-validator-options}

[class-validator options](https://github.com/typestack/class-validator#passing-options)

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

<Tabs
  defaultValue="fastify"
  values={[
    { label: 'Fastify', value: 'fastify' },
    { label: 'Express', value: 'express' },
  ]
}>
<TabItem value="fastify">

```ts title="server/service/app.ts"
import Fastify, { FastifyServerFactory } from 'fastify';
import server from '$/$server';

export const init = (serverFactory?: FastifyServerFactory) => {
  const app = Fastify({ serverFactory });
  server(app, { basePath: '/api', validator: { whitelist: true } });
  return app;
};
```

</TabItem>
<TabItem value="express">

```ts title="server/service/app.ts"
import express from 'express';
import server from '$/$server';

export const init = () => {
  const app = express();
  server(app, { basePath: '/api', validator: { whitelist: true } });
  return app;
};
```

</TabItem>
</Tabs>
